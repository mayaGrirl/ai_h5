import{b as ae,c as T,r as h,j as se}from"./vue-vendor-2ZNhN7Rr.js";import{h as g}from"./index-CIZoSaJ3.js";const C="/api/app/v1/im",oe=()=>g.get(`${C}/config`,{}),re=(t,n)=>g.post(`${C}/ws/connect`,{socket_id:t,channel:n}),P=t=>g.post(`${C}/ws/disconnect`,{socket_id:t}),ce=t=>g.post(`${C}/ws/heartbeat`,{socket_id:t}),ie=()=>g.get(`${C}/unread`,{}),le=(t=1,n=20)=>g.get(`${C}/conversations`,{params:{page:t,size:n}}),ue=t=>g.post(`${C}/conversations`,t),de=t=>g.get(`${C}/conversations/${t}`,{}),fe=(t,n=20,o)=>g.get(`${C}/conversations/${t}/messages`,{params:{limit:n,before_id:o}}),ve=t=>g.post(`${C}/messages`,t),ge=t=>g.post(`${C}/messages/recall`,{message_id:t}),Ce=(t,n)=>g.post(`${C}/messages/read`,{conversation_id:t,message_id:n}),_e=(t=1,n=20,o)=>g.get(`${C}/notifications`,{params:{page:t,size:n,type:o}}),pe=(t,n=!1)=>g.post(`${C}/notifications/read`,{notification_id:t,mark_all:n}),f={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",RECONNECTING:"reconnecting"};let l=null,D=null,O=null,M=0;const A=5,me=3e3,he=3e4,d=h(f.DISCONNECTED),v=h(null),E=h(null),k=new Map;function Ne(t){const{scheme:n,host:o,port:_,app_key:m}=t.reverb;return`${n==="https"?"wss":"ws"}://${o}:${_}/app/${m}?protocol=7&client=js&version=8.4.0&flash=false`}function Ee(){$(),D=setInterval(async()=>{if(v.value&&d.value===f.CONNECTED)try{await ce(v.value)}catch(t){console.warn("[IM WebSocket] Heartbeat failed:",t)}},he)}function $(){D&&(clearInterval(D),D=null)}function L(){O&&(clearTimeout(O),O=null)}function w(t,n){const o=k.get(t);o&&o.forEach(_=>{try{_(n)}catch(m){console.error(`[IM WebSocket] Event listener error for ${t}:`,m)}})}function be(t){try{const n=JSON.parse(t.data);if(n.event){if(n.event==="pusher:connection_established"){const _=JSON.parse(n.data);v.value=_.socket_id,d.value=f.CONNECTED,M=0,Se(),Ee(),w("connected",{socket_id:v.value});return}if(n.event==="pusher_internal:subscription_succeeded"){w("subscribed",{channel:n.channel});return}if(n.event==="pusher:error"){console.error("[IM WebSocket] Pusher error:",n.data),w("error",n.data);return}const o=typeof n.data=="string"?JSON.parse(n.data):n.data;w(n.event,o),w("message",{event:n.event,data:o,channel:n.channel})}}catch(n){console.error("[IM WebSocket] Failed to parse message:",n)}}async function Se(){if(!(!v.value||!E.value))try{await re(v.value,E.value.channels.user),console.log("[IM WebSocket] Connection registered")}catch(t){console.error("[IM WebSocket] Failed to register connection:",t)}}function U(t){if(!l||d.value!==f.CONNECTED){console.warn("[IM WebSocket] Cannot subscribe, not connected");return}const n=JSON.stringify({event:"pusher:subscribe",data:{channel:t}});l.send(n)}function ye(t){if(!l||d.value!==f.CONNECTED)return;const n=JSON.stringify({event:"pusher:unsubscribe",data:{channel:t}});l.send(n)}function Me(){async function t(){if(!(d.value===f.CONNECTED||d.value===f.CONNECTING)){d.value=f.CONNECTING;try{const c=await oe();if(c.code!==0||!c.data)throw new Error(c.message||"Failed to get connection config");E.value=c.data,l&&(l.close(),l=null);const u=Ne(E.value);l=new WebSocket(u),l.onopen=()=>{console.log("[IM WebSocket] Connection opened")},l.onmessage=be,l.onerror=p=>{console.error("[IM WebSocket] Error:",p),w("error",p)},l.onclose=p=>{console.log("[IM WebSocket] Connection closed:",p.code,p.reason),d.value=f.DISCONNECTED,$(),v.value&&(P(v.value).catch(()=>{}),v.value=null),w("disconnected",{code:p.code,reason:p.reason}),p.code!==1e3&&M<A&&o()}}catch(c){console.error("[IM WebSocket] Failed to connect:",c),d.value=f.DISCONNECTED,w("error",c),M<A&&o()}}}function n(){L(),$(),M=A,l&&(l.close(1e3,"User disconnect"),l=null),v.value&&(P(v.value).catch(()=>{}),v.value=null),d.value=f.DISCONNECTED}function o(){L(),M++,d.value=f.RECONNECTING;const c=me*M;console.log(`[IM WebSocket] Scheduling reconnect in ${c}ms (attempt ${M})`),O=setTimeout(()=>{t()},c)}function _(c,u){return k.has(c)||k.set(c,new Set),k.get(c).add(u),()=>m(c,u)}function m(c,u){const p=k.get(c);p&&p.delete(u)}function b(){E.value&&U(`private-${E.value.channels.user}`)}function S(){E.value&&U(E.value.channels.system)}return ae(()=>{}),{connectionState:T(()=>d.value),socketId:T(()=>v.value),isConnected:T(()=>d.value===f.CONNECTED),isConnecting:T(()=>d.value===f.CONNECTING),connect:t,disconnect:n,on:_,off:m,subscribeChannel:U,unsubscribeChannel:ye,subscribePrivate:b,subscribeSystem:S}}function we(){k.clear()}function Ie(){we(),L(),$(),M=0,l&&(l.close(1e3,"Reset"),l=null),v.value=null,d.value=f.DISCONNECTED,E.value=null}const De=se("im",()=>{const t=h([]),n=h(null),o=h(new Map),_=h([]),m=h(0),b=h(0),S=h(!1),c=h(!0),u=Me(),p=T(()=>[...t.value].sort((e,a)=>e.is_pinned!==a.is_pinned?e.is_pinned?-1:1:new Date(a.updated_at).getTime()-new Date(e.updated_at).getTime())),G=T(()=>n.value?o.value.get(n.value.id)||[]:[]);async function j(){await u.connect(),B(),await W(),await J()}function B(){u.on("message.sent",e=>{Z(e)}),u.on("message.recalled",e=>{ee(e)}),u.on("connected",()=>{u.subscribePrivate(),u.subscribeSystem()})}function V(){Ie(),t.value=[],n.value=null,o.value.clear(),_.value=[],m.value=0,b.value=0}async function W(e=1){try{S.value=!0;const a=await le(e);a.code===0&&a.data&&(e===1?t.value=a.data.list:t.value.push(...a.data.list))}catch(a){console.error("Failed to load conversations:",a)}finally{S.value=!1}}async function X(e){try{const s=await ue({type:1,target_id:e});if(s.code===0&&s.data)return await W(),s.data.conversation_id}catch(a){console.error("Failed to create conversation:",a)}return null}async function Y(e){let a=t.value.find(s=>s.id===e);if(!a)try{const s=await de(e);if(s.code===0&&s.data){const i=s.data;t.value.unshift(i),a=i}}catch(s){console.error("Failed to get conversation detail:",s);return}a&&(n.value=a,o.value.has(e)||await R(e),a.unread_count>0&&H(e))}function q(){n.value=null}async function R(e,a){try{S.value=!0;const s=await fe(e,20,a);if(s.code===0&&s.data){const i=o.value.get(e)||[];a?o.value.set(e,[...s.data.messages,...i]):o.value.set(e,s.data.messages),c.value=s.data.has_more}}catch(s){console.error("Failed to load messages:",s)}finally{S.value=!1}}async function z(){if(!n.value||!c.value||S.value)return;const e=G.value;if(e.length===0)return;const a=e[0].id;await R(n.value.id,a)}async function K(e,a){if(!n.value||!e.trim())return!1;const s=n.value.id,i=`local_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,N={id:0,local_id:i,conversation_id:s,sender_id:0,type:1,content:e.trim(),is_recalled:!1,status:0,reply_to_id:a,created_at:new Date().toISOString()},r=o.value.get(s)||[];r.push(N),o.value.set(s,r);try{const x={conversation_id:s,content:e.trim(),reply_to_id:a},I=await ve(x);if(I.code===0&&I.data){const y=r.findIndex(F=>F.local_id===i);return y!==-1&&(r[y]={...r[y],id:I.data.message_id,status:1,created_at:I.data.created_at},o.value.set(s,[...r])),!0}else{const y=r.findIndex(F=>F.local_id===i);return y!==-1&&(r[y].status=-1,o.value.set(s,[...r])),!1}}catch(x){console.error("Failed to send message:",x);const I=r.findIndex(y=>y.local_id===i);return I!==-1&&(r[I].status=-1,o.value.set(s,[...r])),!1}}async function Q(e){try{if((await ge(e)).code===0){if(n.value){const s=o.value.get(n.value.id);if(s){const i=s.findIndex(N=>N.id===e);i!==-1&&(s[i].is_recalled=!0,o.value.set(n.value.id,[...s]))}}return!0}}catch(a){console.error("Failed to recall message:",a)}return!1}async function H(e){try{await Ce(e);const a=t.value.find(s=>s.id===e);a&&(m.value-=a.unread_count,a.unread_count=0)}catch(a){console.error("Failed to mark as read:",a)}}function Z(e){const{conversation_id:a}=e,s={id:e.id,conversation_id:e.conversation_id,sender_id:e.sender_id,sender:e.sender,type:e.type,content:e.content,is_recalled:!1,created_at:e.created_at},i=o.value.get(a)||[];i.some(r=>r.id===s.id)||(i.push(s),o.value.set(a,i));const N=t.value.findIndex(r=>r.id===a);if(N!==-1){const r=t.value[N];r.last_message=s,r.updated_at=s.created_at,(!n.value||n.value.id!==a)&&(r.unread_count++,m.value++),t.value.splice(N,1),t.value.unshift(r)}}function ee(e){const{message_id:a,conversation_id:s}=e,i=o.value.get(s);if(i){const N=i.findIndex(r=>r.id===a);N!==-1&&(i[N].is_recalled=!0,o.value.set(s,[...i]))}}async function J(){try{const e=await ie();e.code===0&&e.data&&(m.value=e.data.total_unread,b.value=e.data.notification_unread)}catch(e){console.error("Failed to refresh unread stats:",e)}}async function te(e=1){try{const a=await _e(e);a.code===0&&a.data&&(e===1?_.value=a.data.list:_.value.push(...a.data.list),b.value=a.data.unread_count)}catch(a){console.error("Failed to load notifications:",a)}}async function ne(){try{await pe(void 0,!0),_.value.forEach(e=>e.is_read=!0),b.value=0}catch(e){console.error("Failed to mark notifications as read:",e)}}return{conversations:t,currentConversation:n,messages:o,notifications:_,totalUnread:m,notificationUnread:b,isLoading:S,hasMoreMessages:c,sortedConversations:p,currentMessages:G,isConnected:u.isConnected,connectionState:u.connectionState,init:j,cleanup:V,loadConversations:W,getOrCreatePrivateConversation:X,setCurrentConversation:Y,clearCurrentConversation:q,loadMessages:R,loadMoreMessages:z,sendMessage:K,recallMessage:Q,markConversationRead:H,refreshUnreadStats:J,loadNotifications:te,markAllNotificationsRead:ne}});export{De as u};
