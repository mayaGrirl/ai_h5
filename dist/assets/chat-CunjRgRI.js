import{d as $,o as q,c as _,R as b,w as G,b as O,q as r,n as a,f as y,y as i,C as u,x as h,r as g,F as I,t as J,p as P,G as Q,S as W,U as X,u as v,D as Y,l as n,L as Z}from"./vue-vendor-2ZNhN7Rr.js";import{u as ee}from"./im-CEEchYxF.js";import{c as k,u as te,_ as se}from"./index-CIZoSaJ3.js";import{A as ae}from"./arrow-left-DS648bW8.js";import{C as re}from"./chevron-down-Bz7Y6ezo.js";import"./utils-vendor-CbLx3nH2.js";/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=k("EllipsisVerticalIcon",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=k("ImageIcon",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=k("SendIcon",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-vue-next v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=k("SmileIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]),ce={class:"flex h-full flex-col bg-gray-100"},ue={class:"sticky top-0 z-10 flex h-12 items-center justify-between bg-white px-4 shadow-sm"},de={class:"flex-1 text-center"},fe={class:"truncate text-base font-medium text-gray-900"},ye={key:0,class:"text-xs text-yellow-500"},he={class:"flex h-8 w-8 items-center justify-center rounded-full hover:bg-gray-100"},xe={key:0,class:"flex items-center justify-center py-2"},pe={key:1,class:"py-2 text-center text-xs text-gray-400"},ve={key:2,class:"flex h-full items-center justify-center"},ge={key:0,class:"my-4 flex items-center justify-center"},me={class:"rounded-full bg-gray-200 px-3 py-1 text-xs text-gray-500"},we=["src"],_e={key:0,class:"mb-1 text-xs text-gray-500"},be=["onLongpress"],ke={key:0,class:"text-xs"},Se={key:0,class:"whitespace-pre-wrap"},De=["src"],Me={key:2},Ce={key:1},je=["src"],Le={class:"sticky bottom-0 border-t border-gray-200 bg-white px-4 py-3"},Ie={class:"flex items-end gap-2"},Te={class:"flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full hover:bg-gray-100"},Re={class:"flex-1"},Ee={class:"flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full hover:bg-gray-100"},He=["disabled"],ze=$({__name:"chat",setup(Be){const T=Z(),R=Y(),o=ee(),M=te(),C=_(()=>Number(T.params.id)),x=g(""),l=g(null),E=g(null),m=g(!1),S=g(!1),H=_(()=>M.currentCustomer?.id||0),p=_(()=>o.currentMessages),D=_(()=>o.currentConversation);function z(t){return new Date(t).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}function B(t){const s=new Date(t),e=new Date;if(s.toDateString()===e.toDateString())return"今天";const f=new Date(e);return f.setDate(f.getDate()-1),s.toDateString()===f.toDateString()?"昨天":s.toLocaleDateString("zh-CN",{month:"long",day:"numeric"})}function N(t){if(t===0)return!0;const s=p.value[t],e=p.value[t-1],f=new Date(s.created_at).toDateString(),d=new Date(e.created_at).toDateString();return f!==d}function c(t){return t.sender_id===H.value}function j(t){return t.status===0?"发送中...":t.status===-1?"发送失败":""}async function L(){const t=x.value.trim();t&&(x.value="",await o.sendMessage(t),await b(),w())}function V(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),L())}function w(t=!0){l.value&&l.value.scrollTo({top:l.value.scrollHeight,behavior:t?"smooth":"auto"})}async function U(){if(m.value||!o.hasMoreMessages)return;m.value=!0;const t=l.value?.scrollHeight||0;try{if(await o.loadMoreMessages(),await b(),l.value){const s=l.value.scrollHeight;l.value.scrollTop=s-t}}finally{m.value=!1}}function A(){if(!l.value)return;const{scrollTop:t,scrollHeight:s,clientHeight:e}=l.value;S.value=s-t-e>200,t<50&&U()}async function K(t){confirm("确定要撤回这条消息吗？")&&await o.recallMessage(t.id)}function F(){o.clearCurrentConversation(),R.back()}return q(async()=>{C.value&&(await o.setCurrentConversation(C.value),await b(),w(!1))}),G(()=>p.value.length,async(t,s)=>{t>s&&(await b(),S.value||w())}),O(()=>{o.clearCurrentConversation()}),(t,s)=>(n(),r("div",ce,[a("header",ue,[a("button",{onClick:F,class:"flex h-8 w-8 items-center justify-center rounded-full hover:bg-gray-100"},[y(i(ae),{class:"h-5 w-5 text-gray-600"})]),a("div",de,[a("h1",fe,h(D.value?.name||D.value?.target?.nickname||"聊天"),1),i(o).isConnected?u("",!0):(n(),r("p",ye,"连接中..."))]),a("button",he,[y(i(ne),{class:"h-5 w-5 text-gray-600"})])]),a("div",{ref_key:"messageListRef",ref:l,onScroll:A,class:"flex-1 overflow-y-auto px-4 py-2"},[m.value?(n(),r("div",xe,[...s[5]||(s[5]=[a("div",{class:"h-4 w-4 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"},null,-1),a("span",{class:"ml-2 text-xs text-gray-400"},"加载中...",-1)])])):u("",!0),!i(o).hasMoreMessages&&p.value.length>0?(n(),r("div",pe," 没有更多消息了 ")):u("",!0),p.value.length===0&&!i(o).isLoading?(n(),r("div",ve,[...s[6]||(s[6]=[a("p",{class:"text-sm text-gray-400"},"开始聊天吧",-1)])])):u("",!0),(n(!0),r(I,null,J(p.value,(e,f)=>(n(),r("div",{key:e.id||e.local_id,class:"mb-3"},[N(f)?(n(),r("div",ge,[a("span",me,h(B(e.created_at)),1)])):u("",!0),a("div",{class:v(["flex",c(e)?"justify-end":"justify-start"])},[c(e)?u("",!0):(n(),r("img",{key:0,src:e.sender?.avatar||"/default-avatar.png",class:"mr-2 h-9 w-9 flex-shrink-0 rounded-full object-cover",onError:s[0]||(s[0]=d=>d.target.src="/default-avatar.png")},null,40,we)),a("div",{class:v(["max-w-[70%]",c(e)?"items-end":"items-start"])},[!c(e)&&D.value?.type===2?(n(),r("p",_e,h(e.sender?.nickname),1)):u("",!0),a("div",{class:v(["relative rounded-2xl px-3 py-2 text-sm break-words",c(e)?"bg-blue-500 text-white rounded-br-sm":"bg-white text-gray-800 rounded-bl-sm shadow-sm",e.is_recalled?"italic opacity-60":""]),onLongpress:d=>c(e)&&!e.is_recalled&&K(e)},[e.is_recalled?(n(),r("span",ke,"消息已撤回")):(n(),r(I,{key:1},[e.type===1?(n(),r("p",Se,h(e.content),1)):e.type===2?(n(),r("img",{key:1,src:e.attachment?.url||e.attachment?.path,class:"max-w-full rounded",onError:s[1]||(s[1]=d=>d.target.src="/image-error.png")},null,40,De)):(n(),r("p",Me,"["+h(e.type===3?"语音":e.type===4?"视频":"文件")+"]",1))],64))],42,be),a("div",{class:v(["mt-1 flex items-center text-xs text-gray-400",c(e)?"justify-end":"justify-start"])},[c(e)&&j(e)?(n(),r("span",{key:0,class:v(e.status===-1?"text-red-500":"")},h(j(e)),3)):(n(),r("span",Ce,h(z(e.created_at)),1))],2)],2),c(e)?(n(),r("img",{key:1,src:i(M).currentCustomer?.avatar||"/default-avatar.png",class:"ml-2 h-9 w-9 flex-shrink-0 rounded-full object-cover",onError:s[2]||(s[2]=d=>d.target.src="/default-avatar.png")},null,40,je)):u("",!0)],2)]))),128))],544),y(Q,{name:"fade"},{default:P(()=>[S.value?(n(),r("button",{key:0,onClick:s[3]||(s[3]=e=>w()),class:"absolute bottom-20 right-4 flex h-10 w-10 items-center justify-center rounded-full bg-white shadow-lg"},[y(i(re),{class:"h-5 w-5 text-gray-600"})])):u("",!0)]),_:1}),a("div",Le,[a("div",Ie,[a("button",Te,[y(i(ie),{class:"h-5 w-5 text-gray-500"})]),a("div",Re,[W(a("textarea",{ref_key:"inputRef",ref:E,"onUpdate:modelValue":s[4]||(s[4]=e=>x.value=e),onKeydown:V,placeholder:"输入消息...",rows:"1",class:"w-full resize-none rounded-2xl border border-gray-200 bg-gray-50 px-4 py-2 text-sm outline-none focus:border-blue-400 focus:bg-white",style:{"max-height":"100px"}},null,544),[[X,x.value]])]),a("button",Ee,[y(i(oe),{class:"h-5 w-5 text-gray-500"})]),a("button",{onClick:L,disabled:!x.value.trim(),class:v(["flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full transition-colors",x.value.trim()?"bg-blue-500 text-white hover:bg-blue-600":"bg-gray-200 text-gray-400"])},[y(i(le),{class:"h-4 w-4"})],10,He)])])]))}}),$e=se(ze,[["__scopeId","data-v-3ba2e0c3"]]);export{$e as default};
